name: Terraform CI/CD Pipeline

on:
  # 1. Automatic CI for PRs and Pushes
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # 2. Manual workflow for controlled execution of apply/destroy
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action (plan, apply, or destroy)'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Target Environment (e.g., dev, prod)'
        required: true
        default: 'dev'
        type: string

env:
  TF_WORKING_DIR: ./terraform  # Your Terraform code folder

jobs:
  # =============================================================================
  # CI JOB: Validate and Plan (Run automatically on PR/Push)
  # =============================================================================
  validate_and_plan:
    name: 'Terraform Validate & Plan'
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    env:
      # Default variables from terraform/variables.tf
      PROJECT_NAME: devopspipeline
      ADMIN_USERNAME: azureuser
      ENVIRONMENT_NAME: dev # Default environment for CI validation

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          # Ensure you use the same version as your team
          terraform_version: 1.8.0 

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          # Required for Azure provider authentication. Needs AZURE_CREDENTIALS secret.
          creds: ${{ secrets.AZURE_CREDENTIALS }} 

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}
      
      # Use -var flags to pass all required variables, including the sensitive SSH key
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -no-color \
            -out=tfplan \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Publish Plan Artifact (for Apply/Destroy steps)
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-artifact
          path: ${{ env.TF_WORKING_DIR }}/tfplan
          retention-days: 1

  # =============================================================================
  # CD JOB: Apply and Destroy (Run manually via workflow_dispatch)
  # =============================================================================
  apply_and_destroy:
    name: 'Terraform Apply/Destroy (${{ github.event.inputs.action }})'
    runs-on: ubuntu-latest
    # This job only runs when manually triggered
    if: github.event_name == 'workflow_dispatch' 
    needs: validate_and_plan
    environment: ${{ github.event.inputs.environment }} # Use environment for protection rules

    env:
      # Default variables from terraform/variables.tf
      PROJECT_NAME: devopspipeline
      ADMIN_USERNAME: azureuser
      # Use environment input from the manual trigger
      ENVIRONMENT_NAME: ${{ github.event.inputs.environment }} 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0 

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} 

      - name: Terraform Init (Download existing state)
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        
      # Download the plan generated by the previous job
      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-artifact
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply (Controlled Execution)
        if: github.event.inputs.action == 'apply'
        run: |
          terraform apply \
            -auto-approve \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}" \
            tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}
        
      - name: Terraform Destroy (Manual Cleanup)
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy \
            -auto-approve \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan (Manual Rerun, if needed)
        if: github.event.inputs.action == 'plan'
        run: |
          terraform plan \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}"
        working-directory: ${{ env.TF_WORKING_DIR }}