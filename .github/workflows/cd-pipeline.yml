name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18'
  ACR_NAME: ${{ secrets.ACR_NAME }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Login to Azure Container Registry
        id: acr-login
        uses: azure/docker-login@v1
        continue-on-error: true
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata (image tag)
        id: meta
        run: |
          echo "version=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        if: steps.acr-login.outcome == 'success'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-backend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-backend:latest

      - name: Build and push frontend image
        if: steps.acr-login.outcome == 'success'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-frontend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-frontend:latest

      # Optional Scans
      - name: Scan backend image
        if: steps.acr-login.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/inventory-backend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: Scan frontend image
        if: steps.acr-login.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/inventory-frontend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-*-results.sarif'

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install azure.azcollection
          ansible-galaxy collection install community.docker

      - name: Validate deployment prerequisites
        run: |
          if [ -z "${{ secrets.VM_PUBLIC_IP }}" ]; then
            echo "âŒ Error: VM_PUBLIC_IP secret is not set"
            echo "Please ensure Terraform has run successfully and VM_PUBLIC_IP is configured in repository secrets"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Wait for VM to be ready
        run: |
          echo "ðŸ” Checking if VM is reachable at ${{ secrets.VM_PUBLIC_IP }}..."
          
          # Wait for VM to respond to ping or SSH port
          MAX_WAIT=300  # 5 minutes
          ELAPSED=0
          INTERVAL=10
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check if SSH port is open using nc (netcat) or timeout
            if timeout 5 bash -c "echo > /dev/tcp/${{ secrets.VM_PUBLIC_IP }}/22" 2>/dev/null; then
              echo "âœ… VM is reachable! SSH port 22 is open."
              break
            else
              echo "â³ VM not ready yet (${ELAPSED}s/${MAX_WAIT}s), waiting..."
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            fi
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ VM did not become reachable within 5 minutes"
            echo "Possible issues:"
            echo "  - VM is not running (check Terraform apply succeeded)"
            echo "  - NSG rules blocking port 22"
            echo "  - Incorrect IP address: ${{ secrets.VM_PUBLIC_IP }}"
            exit 1
          fi

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Retry ssh-keyscan with timeout
          echo "Scanning SSH keys for ${{ secrets.VM_PUBLIC_IP }}..."
          for i in {1..5}; do
            if ssh-keyscan -H -T 10 ${{ secrets.VM_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "âœ… SSH key scan successful"
              break
            else
              echo "â³ Attempt $i/5 failed, retrying in 10s..."
              sleep 10
            fi
          done
          
          # Verify known_hosts was populated
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "âŒ Failed to scan SSH keys after 5 attempts"
            echo "VM might not be ready or SSH port (22) might not be accessible"
            exit 1
          fi

      - name: Create Inventory File
        run: |
          mkdir -p ansible/inventory
          cat > ansible/inventory/hosts << EOF
          [app_servers]
          azure-vm ansible_host=${{ secrets.VM_PUBLIC_IP }} ansible_user=azureuser
          EOF

      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          # Disable SSH multiplexing to prevent connection drops
          ANSIBLE_SSH_PIPELINING: False
          ANSIBLE_SSH_ARGS: "-o ControlMaster=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10"
        run: |
          ansible-playbook playbooks/server-setup.yml -i inventory/hosts -v \
            -e "acr_login_server=${{ secrets.ACR_LOGIN_SERVER }}" \
            -e "acr_username=${{ secrets.ACR_USERNAME }}" \
            -e "acr_password=${{ secrets.ACR_PASSWORD }}" \
            -e "image_tag=${{ needs.build-and-push.outputs.image_tag }}"

      - name: Wait & Verify Backend
        run: |
          sleep 25
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:5000/health

      - name: Verify Frontend
        run: |
          curl -f http://${{ secrets.VM_PUBLIC_IP }}

  post-deployment:
    name: Post Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Test Frontend
        run: curl -f http://${{ secrets.VM_PUBLIC_IP }}

      - name: Test Backend API
        run: |
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:5000/health
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:5000/api

      - name: Deployment Success Notification
        run: echo "ðŸŽ‰ Deployment successful!"
