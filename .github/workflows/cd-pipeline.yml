name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18'
  ACR_NAME: ${{ secrets.ACR_NAME }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Azure Container Registry
        id: acr-login
        uses: azure/docker-login@v1
        continue-on-error: true
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata (image tag)
        id: meta
        run: |
          echo "version=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        if: steps.acr-login.outcome == 'success'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-backend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push frontend image
        if: steps.acr-login.outcome == 'success'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-frontend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/inventory-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Optional Scans
      - name: Scan backend image
        if: steps.acr-login.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/inventory-backend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: Scan frontend image
        if: steps.acr-login.outcome == 'success'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/inventory-frontend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-*-results.sarif'

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install azure.azcollection
          ansible-galaxy collection install community.docker

      - name: Validate deployment prerequisites
        run: |
          if [ -z "${{ secrets.VM_PUBLIC_IP }}" ]; then
            echo "âŒ Error: VM_PUBLIC_IP secret is not set"
            echo "Please ensure Terraform has run successfully and VM_PUBLIC_IP is configured in repository secrets"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Create Inventory File
        run: |
          mkdir -p ansible/inventory
          cat > ansible/inventory/hosts << EOF
          [app_servers]
          azure-vm ansible_host=${{ secrets.VM_PUBLIC_IP }} ansible_user=azureuser
          EOF

      - name: Run Ansible Playbook
        working-directory: ./ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
        run: |
          ansible-playbook playbooks/server-setup.yml -i inventory/hosts -v

      - name: Wait & Verify Backend
        run: |
          sleep 25
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:5000/health

      - name: Verify Frontend
        run: |
          curl -f http://${{ secrets.VM_PUBLIC_IP }}

  post-deployment:
    name: Post Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Test Frontend
        run: curl -f http://${{ secrets.VM_PUBLIC_IP }}

      - name: Test Backend API
        run: |
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:5000/health
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:5000/api

      - name: Deployment Success Notification
        run: echo "ðŸŽ‰ Deployment successful!"
