name: Terraform CI/CD Pipeline

on:
  # 1. Automatic CI for PRs and Pushes
  push:
    branches:
      - main
      - develop # Added develop branch to trigger CI
  pull_request:
    branches:
      - main
      - develop # Added develop branch to trigger CI
  # 2. Manual workflow for controlled execution of apply/destroy
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform Action (plan, apply, or destroy)'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: 'Target Environment (e.g., dev, prod)'
        required: true
        default: 'dev'
        type: string

env:
  TF_WORKING_DIR: ./terraform  # Your Terraform code folder

jobs:
 
  validate_and_plan:
    name: 'Terraform Validate & Plan'
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    env:
      # Default variables from terraform/variables.tf
      PROJECT_NAME: devopspipeline
      ADMIN_USERNAME: azureuser
      ENVIRONMENT_NAME: ${{ github.event.inputs.environment || 'dev' }}
      # ðŸ’¥ CRITICAL FIX: Expose Terraform Cloud API Token for 'terraform init' authentication
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }} 
      # Explicitly set Azure credentials for Terraform backend auth
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }} 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0 
          terraform_wrapper: false 

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} 

      - name: Terraform Init (Using Azure Storage Backend)
        id: init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}
      
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -no-color \
            -out=tfplan \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Publish Plan Artifact (for Apply/Destroy steps)
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-artifact
          path: ${{ env.TF_WORKING_DIR }}/tfplan
          retention-days: 1

  # =============================================================================
  # CD JOB: Apply and Destroy (Run manually via workflow_dispatch)
  # =============================================================================
  apply_and_destroy:
    name: 'Terraform Apply/Destroy (${{ github.event.inputs.action }})'
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) 
    needs: validate_and_plan
    environment: ${{ github.event.inputs.environment || 'dev' }}

    env:
      PROJECT_NAME: devopspipeline
      ADMIN_USERNAME: azureuser
      ENVIRONMENT_NAME: ${{ github.event.inputs.environment || 'dev' }} 
      # ðŸ’¥ CRITICAL FIX: Expose Terraform Cloud API Token for 'terraform init' authentication
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }} 
      # Explicitly set Azure credentials for Terraform backend auth
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }} 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.0 
          terraform_wrapper: false 

      - name: Azure CLI Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} 

      # DISABLED: This step deletes the ENTIRE resource group on every push
      # Causes: New IP addresses, new ACR names, complete infrastructure recreation
      # Solution: Remove this step and use proper Terraform state management
      # - name: Cleanup Pre-existing Resources (Stateless Workaround)
      #   if: github.event.inputs.action == 'apply' || github.event_name == 'push'
      #   run: |
      #     echo "Deleting resource group to ensure clean state..."
      #     az group delete --name ${{ env.PROJECT_NAME }}-${{ env.ENVIRONMENT_NAME }}-rg --yes || true
      #     echo "Deletion completed."
      #   working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Init (Download existing state)
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
        
      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-artifact
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply (Controlled Execution)
        if: github.event.inputs.action == 'apply' || github.event_name == 'push'
        run: |
          terraform apply \
            -auto-approve \
            tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}
        
      - name: Terraform Destroy (Manual Cleanup)
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy \
            -auto-approve \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}"
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan (Manual Rerun, if needed)
        if: github.event.inputs.action == 'plan'
        run: |
          terraform plan \
            -var="project_name=${{ env.PROJECT_NAME }}" \
            -var="environment=${{ env.ENVIRONMENT_NAME }}" \
            -var="admin_username=${{ env.ADMIN_USERNAME }}" \
            -var="ssh_public_key=${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}"
        working-directory: ${{ env.TF_WORKING_DIR }}

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    concurrency: env-production
    needs: [terraform-plan, terraform-security]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    environment:
      name: production
    env:
      TF_WORKING_DIR: ./terraform
      # Default variables from terraform/variables.tf
      PROJECT_NAME: devopspipeline
      ADMIN_USERNAME: azureuser
      ENVIRONMENT_NAME: ${{ github.event.inputs.environment || 'dev' }}
      # ðŸ’¥ CRITICAL FIX: Expose Terraform Cloud API Token for 'terraform init' authentication
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }} 
      # Explicitly set Azure credentials for Terraform backend auth
      ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }} 

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Plan (fresh)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -input=false -out=tfplan

      - name: Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -input=false -auto-approve tfplan
