---
- name: Create application directory
  file:
    path: /opt/inventory-app
    state: directory
    owner: "{{ ansible_user }}"
    group: docker
    mode: '0755'

- name: Login to Azure Container Registry
  shell: |
    echo "{{ acr_password }}" | docker login {{ acr_login_server }} -u {{ acr_username }} --password-stdin
  become: yes
  no_log: true

- name: Create docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: /opt/inventory-app/docker-compose.yml
    owner: "{{ ansible_user }}"
    mode: '0644'

- name: Stop existing containers (if any)
  community.docker.docker_compose_v2:
    project_src: /opt/inventory-app
    state: stopped
  become: yes
  ignore_errors: yes

- name: Remove existing containers
  community.docker.docker_compose_v2:
    project_src: /opt/inventory-app
    state: absent
    remove_orphans: true
  become: yes
  ignore_errors: yes

- name: Pull latest images
  shell: |
    cd /opt/inventory-app
    docker compose pull
  become: yes
  register: pull_result

- name: Display pull result
  debug:
    var: pull_result.stdout_lines

- name: Start application containers
  community.docker.docker_compose_v2:
    project_src: /opt/inventory-app
    state: present
    recreate: always
    remove_orphans: true
  become: yes
  register: docker_result
  ignore_errors: yes

- name: Display container status
  debug:
    var: docker_result

- name: Get container logs on failure
  shell: |
    echo "=== MongoDB Logs ==="
    docker logs inventory-mongodb --tail 50 2>&1 || echo "MongoDB container not found"
    echo ""
    echo "=== Backend Logs ==="
    docker logs inventory-backend --tail 50 2>&1 || echo "Backend container not found"
    echo ""
    echo "=== Frontend Logs ==="
    docker logs inventory-frontend --tail 50 2>&1 || echo "Frontend container not found"
    echo ""
    echo "=== Container Status ==="
    docker ps -a --filter "name=inventory-"
  become: yes
  when: docker_result.failed is defined and docker_result.failed
  register: container_logs

- name: Display container logs
  debug:
    var: container_logs.stdout_lines
  when: docker_result.failed is defined and docker_result.failed

- name: Fail if containers didn't start
  fail:
    msg: "Containers failed to start. Check logs above for details."
  when: docker_result.failed is defined and docker_result.failed

- name: Wait for backend to be ready
  # checkov:skip=CKV2_ANSIBLE_1:Using HTTP for local health check
  uri:
    url: "http://localhost:5000/health"
    status_code: 200
  register: backend_result
  until: backend_result.status == 200
  retries: 30
  delay: 2

- name: Wait for frontend to be ready
  # checkov:skip=CKV2_ANSIBLE_1:Using HTTP for local health check
  uri:
    url: "http://localhost:3000"
    status_code: 200
  register: frontend_result
  until: frontend_result.status == 200
  retries: 30
  delay: 2